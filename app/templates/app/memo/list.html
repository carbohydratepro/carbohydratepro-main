{% extends "app/base.html" %}
{% load static %}
{% load app_filters %}
{% block content %}
<div class="container mt-2">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <h2 class="mb-2">メモ</h2>
        <div class="d-flex flex-row align-items-center">
            <div class="btn-group btn-group-sm mr-2 mb-1" role="group" aria-label="表示切替">
                <button type="button" class="btn btn-primary" id="markdownToggleOn" onclick="setMarkdownMode(true)">
                    <i class="fas fa-paragraph"></i>
                    <span class="d-none d-sm-inline"> Markdown表示</span>
                    <span class="d-sm-none"> MD</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="markdownToggleOff" onclick="setMarkdownMode(false)">
                    <i class="fas fa-align-left"></i>
                    <span class="d-none d-sm-inline"> テキスト表示</span>
                    <span class="d-sm-none"> TXT</span>
                </button>
            </div>
            <div class="d-flex flex-row-reverse">
                <a href="{% url 'memo_settings' %}" class="btn btn-outline-secondary btn-sm mb-1">
                    <i class="fas fa-cog"></i> 種別設定
                </a>
                <button onclick="openCreateMemoModal()" class="btn btn-primary btn-sm mb-1 mr-2">
                    <i class="fas fa-plus"></i> 新規メモ作成
                </button>
            </div>
        </div>
    </div>

    <!-- 検索・絞り込み機能 -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <button class="btn btn-link btn-sm p-0" type="button" data-toggle="collapse" data-target="#memoSearchFilterCollapse" aria-expanded="false">
                <i class="fas fa-search"></i> 検索・絞り込み
            </button>
        </div>
        <div class="collapse" id="memoSearchFilterCollapse">
            <div class="card-body py-2">
                <form id="filterForm" method="GET">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label for="search" class="form-label small">検索</label>
                            <input type="text" id="search" name="search" class="form-control form-control-sm" 
                                   placeholder="タイトルまたは内容で検索..." value="{{ search_query }}">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="memo_type_filter" class="form-label small">種別</label>
                            <select id="memo_type_filter" name="memo_type" class="form-control form-control-sm">
                                <option value="">すべて</option>
                                {% for type in memo_type_choices %}
                                <option value="{{ type.id }}" {% if memo_type_filter == type.id|stringformat:"s" %}selected{% endif %}>{{ type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="favorite_filter" class="form-label small">お気に入り</label>
                            <select id="favorite_filter" name="favorite" class="form-control form-control-sm">
                                <option value="">すべて</option>
                                <option value="true" {% if favorite_filter == 'true' %}selected{% endif %}>お気に入りのみ</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-sm mr-2">検索</button>
                            <a href="{% url 'memo_list' %}" class="btn btn-secondary btn-sm">クリア</a>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <label for="per_page" class="form-label small mr-2 mb-0">表示件数</label>
                            <select name="per_page" id="per_page" class="form-control form-control-sm" onchange="document.getElementById('filterForm').submit()">
                                {% for size in per_page_options %}
                                <option value="{{ size }}" {% if per_page|stringformat:"s" == size %}selected{% endif %}>{{ size }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 検索結果表示 -->
    {% if search_query or memo_type_filter or favorite_filter %}
    <div class="alert alert-info py-2">
        <strong>検索結果:</strong> {{ page_obj.paginator.count }}件のメモが見つかりました
        {% if search_query %}（検索キーワード: "{{ search_query }}"）{% endif %}
    </div>
    {% endif %}

    <!-- メモリスト -->
    <div class="row">
        {% for memo in page_obj %}
        <div class="col-lg-6 col-md-12 mb-3">
            <div class="card memo-card h-100">
                <div class="card-body py-2 px-3">
                    <!-- 1行目: タイトル（左寄せ）と更新日（右寄せ） -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="card-title mb-0 flex-grow-1 mr-2">{{ memo.title|truncatechars:30|highlight:search_query }}</h6>
                        <span class="text-muted small" style="white-space: nowrap;">
                            <i class="far fa-clock"></i> {{ memo.updated_date|date:"m/d H:i" }}
                        </span>
                    </div>
                    
                    <!-- 2行目: ラベル（左寄せ）とお気に入り・編集・削除ボタン（右寄せ） -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge" style="background-color: {{ memo.memo_type.color }}; color: #fff;">{{ memo.memo_type.name }}</span>
                        </div>
                        <div class="d-flex" style="white-space: nowrap;">
                            <button class="btn btn-sm btn-outline-warning py-0 px-1 mr-1" 
                                    onclick="event.stopPropagation(); toggleFavorite({{ memo.id }}, this)"
                                    data-favorite="{{ memo.is_favorite|yesno:'true,false' }}"
                                    title="{% if memo.is_favorite %}お気に入り解除{% else %}お気に入り{% endif %}">
                                <i class="{% if memo.is_favorite %}fas{% else %}far{% endif %} fa-star"></i>
                            </button>
                            <button onclick="event.stopPropagation(); openEditMemoModal({{ memo.id }})" 
                                    class="btn btn-sm btn-outline-warning py-0 px-1 mr-1" title="編集">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="post" action="{% url 'delete_memo' memo.id %}" style="display: inline;" 
                                  onsubmit="event.stopPropagation(); return confirm('このメモを削除してもよろしいですか？');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1" title="削除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 3行目・4行目: 詳細テキストボックス（枠線付き） -->
                    <div class="memo-preview cursor-pointer border rounded p-2 bg-light" onclick="toggleMemoExpand({{ memo.id }})" style="min-height: 60px;">
                        <p class="card-text text-muted small mb-2" id="preview-{{ memo.id }}">
                            {{ memo.content|highlight:search_query|truncatechars:100 }}
                        </p>
                        <div class="memo-full-content card-text text-muted small mb-2" id="full-content-{{ memo.id }}" data-raw-id="memo-raw-{{ memo.id }}" style="display: none;"></div>
                        <textarea id="memo-raw-{{ memo.id }}" class="d-none memo-raw-src">{{ memo.content }}</textarea>
                        <div class="text-center">
                            <i class="fas fa-chevron-down expand-icon" id="icon-{{ memo.id }}"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-secondary text-center">
                {% if search_query or memo_type_filter or favorite_filter %}
                    検索条件に一致するメモが見つかりませんでした。
                {% else %}
                    メモが登録されていません。
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ページネーション -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="メモページネーション">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                    <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if memo_type_filter %}&memo_type={{ memo_type_filter }}{% endif %}{% if favorite_filter %}&favorite={{ favorite_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">&laquo; 最初</a>
                        </li>
                        <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if memo_type_filter %}&memo_type={{ memo_type_filter }}{% endif %}{% if favorite_filter %}&favorite={{ favorite_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">前へ</a>
                        </li>
                    {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if memo_type_filter %}&memo_type={{ memo_type_filter }}{% endif %}{% if favorite_filter %}&favorite={{ favorite_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if memo_type_filter %}&memo_type={{ memo_type_filter }}{% endif %}{% if favorite_filter %}&favorite={{ favorite_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">次へ</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if memo_type_filter %}&memo_type={{ memo_type_filter }}{% endif %}{% if favorite_filter %}&favorite={{ favorite_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">最後 &raquo;</a>
                </li>
            {% endif %}
        </ul>
    </nav>

    <div class="text-center mt-2">
        <small class="text-muted">
            {{ page_obj.start_index }} - {{ page_obj.end_index }} / {{ page_obj.paginator.count }}件
        </small>
    </div>
    {% endif %}

</div>

<link rel="stylesheet" href="{% static 'app/modal.css' %}">
<link rel="stylesheet" href="{% static 'app/memo.css' %}">
<script src="{% static 'app/markdown-lite.js' %}"></script>
<script src="{% static 'app/memo.js' %}"></script>

<!-- 編集モーダル -->
<div class="modal fade" id="editMemoModal" tabindex="-1" role="dialog" aria-labelledby="editMemoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <!-- モーダルの内容はAjaxで読み込まれます -->
    </div>
</div>

<!-- 新規作成モーダル -->
<div class="modal fade" id="createMemoModal" tabindex="-1" role="dialog" aria-labelledby="createMemoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <!-- モーダルの内容はAjaxで読み込まれます -->
    </div>
</div>
{% endblock %}
