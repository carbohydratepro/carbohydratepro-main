{% extends "app/base.html" %}
{% load static %}
{% load app_filters %}
{% block content %}
<div class="container mt-2">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <h2 class="mb-0">家計簿</h2>
    </div>

    <div class="d-flex flex-row-reverse mb-2">
        <a href="{% url 'expenses_settings' %}" class="btn btn-secondary btn-sm mb-1">
            <i class="fas fa-cog"></i> 設定
        </a>
        <button onclick="openCreateModal()" class="btn btn-primary btn-sm mr-2 mb-1">
            <i class="fas fa-plus"></i> 新規登録
        </button>
    </div>

    <!-- 月選択フォーム -->
    <div class="row mb-3">
        <div class="col-md-6">
            <form id="filterForm" class="form-inline">
                <input type="month" id="target_date" name="target_date" class="form-control" value="{{ default_target_date }}">
            </form>
        </div>
    </div>

    <!-- 検索・絞り込み機能 -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <button class="btn btn-link btn-sm p-0" type="button" data-toggle="collapse" data-target="#searchFilterCollapse" aria-expanded="false">
                <i class="fas fa-search"></i> 検索・絞り込み
            </button>
        </div>
        <div class="collapse" id="searchFilterCollapse">
            <div class="card-body py-2">
                <form method="GET">
                    <input type="hidden" name="target_date" value="{{ default_target_date }}">
                    
                    <!-- 検索 -->
                    <div class="row mb-2">
                        <div class="col-12">
                            <div class="input-group input-group-sm">
                                <input type="text" name="search" class="form-control" placeholder="用途、カテゴリ、支払方法で検索..." value="{{ search_query }}">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 絞り込み -->
                    <div class="row">
                        <div class="col-6 col-md-3">
                            <select name="transaction_type" class="form-control form-control-sm mb-1">
                                <option value="">全ての取引タイプ</option>
                                <option value="income" {% if filter_transaction_type == 'income' %}selected{% endif %}>収入</option>
                                <option value="expense" {% if filter_transaction_type == 'expense' %}selected{% endif %}>支出</option>
                                <option value="no_change" {% if filter_transaction_type == 'no_change' %}selected{% endif %}>変動なし</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <select name="major_category" class="form-control form-control-sm mb-1">
                                <option value="">全ての費用タイプ</option>
                                <option value="variable" {% if filter_major_category == 'variable' %}selected{% endif %}>変動費</option>
                                <option value="fixed" {% if filter_major_category == 'fixed' %}selected{% endif %}>固定費</option>
                                <option value="special" {% if filter_major_category == 'special' %}selected{% endif %}>特別費</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <select name="category" class="form-control form-control-sm mb-1">
                                <option value="">全てのカテゴリ</option>
                                {% for category in user_categories %}
                                <option value="{{ category.id }}" {% if filter_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <select name="payment_method" class="form-control form-control-sm mb-1">
                                <option value="">全ての支払方法</option>
                                {% for payment_method in user_payment_methods %}
                                <option value="{{ payment_method.id }}" {% if filter_payment_method == payment_method.id|stringformat:"s" %}selected{% endif %}>{{ payment_method.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-1">
                        <div class="col-md-6 col-12 mt-2 d-flex align-items-center">
                            <label for="per_page" class="form-label small mb-0 mr-2">表示件数</label>
                            <select name="per_page" id="per_page" class="form-control form-control-sm" onchange="this.form.submit()" style="max-width: 120px;">
                                {% for size in per_page_options %}
                                <option value="{{ size }}" {% if per_page|stringformat:"s" == size %}selected{% endif %}>{{ size }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-12 mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">絞り込み</button>
                            <a href="?target_date={{ default_target_date }}" class="btn btn-outline-secondary btn-sm ml-1">クリア</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 月次サマリー表示 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="mb-0">{{ target_month }} のサマリー</h6>
                </div>
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col-6 col-md-3">
                            <small class="text-primary">収入</small>
                            <div class="h6 text-primary mb-0">+¥{{ total_income_formatted }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <small class="text-danger">支出</small>
                            <div class="h6 text-danger mb-0">-¥{{ total_expense_formatted }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <small {% if net_balance >= 0 %}class="text-success"{% else %}class="text-warning"{% endif %}>収支</small>
                            <div {% if net_balance >= 0 %}class="h6 text-success mb-0"{% else %}class="h6 text-warning mb-0"{% endif %}>{% if net_balance >= 0 %}+{% endif %}¥{{ net_balance_formatted }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <small class="text-info">取引件数</small>
                            <div class="h6 text-info mb-0">{{ transactions_count }}件</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- グラフ表示エリア -->
    <div class="row mb-3">
        <!-- モバイル: 円グラフを横並び、PC: 左上にカテゴリ -->
        <div class="col-md-3 col-6 mb-3">
            <div style="height: 200px;">
                <canvas id="categoryPieChart" class="chart-canvas"></canvas>
            </div>
        </div>
        <!-- モバイル: 円グラフを横並び、PC: 右上に棒グラフ -->
        <div class="col-md-9 col-6 mb-3">
            <div class="d-md-block d-none" style="height: 200px;">
                <canvas id="expenseBarChart" class="chart-canvas"></canvas>
            </div>
            <!-- モバイル: メインカテゴリ円グラフ -->
            <div class="d-md-none" style="height: 200px;">
                <canvas id="majorCategoryChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- PC用下段、モバイル用棒グラフ・折れ線グラフ -->
    <div class="row mb-3">
        <!-- PC: 左下にメインカテゴリ -->
        <div class="col-md-3 d-none d-md-block mb-3">
            <div style="height: 200px;">
                <canvas id="majorCategoryChartPC" class="chart-canvas"></canvas>
            </div>
        </div>
        <!-- PC: 右下に折れ線グラフ -->
        <div class="col-md-9 d-none d-md-block mb-3">
            <div style="height: 200px;">
                <canvas id="balanceLineChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- モバイル: 棒グラフ（全幅） -->
        <div class="col-12 d-md-none mb-2">
            <div style="height: 250px; position: relative;">
                <canvas id="expenseBarChartMobile" class="chart-canvas" style="height: 300px !important;"></canvas>
            </div>
        </div>
        
        <!-- モバイル: 折れ線グラフ（全幅） -->
        <div class="col-12 d-md-none mb-2">
            <div style="height: 250px; position: relative;">
                <canvas id="balanceLineChartMobile" class="chart-canvas" style="height: 250px !important;"></canvas>
            </div>
        </div>
    </div>

    <!-- 取引一覧 -->
    {% if search_query or filter_transaction_type or filter_major_category or filter_category or filter_payment_method %}
    <div class="alert alert-info alert-sm py-2">
        <i class="fas fa-filter"></i> 絞り込み結果: {{ transactions_count }}件
    </div>
    {% endif %}
    
    <div class="row">
        {% for transaction in transactions_page %}
        <div class="col-md-6 col-lg-4 mb-2">
            <div class="card card-sm">
                <div class="card-body p-2">
                    <!-- 1行目: タイトル（左）と日付（右） -->
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="card-title mb-0 text-truncate" title="{{ transaction.purpose }}" style="font-size: 0.9rem;">
                            {{ transaction.purpose|truncatechars:30 }}
                        </h6>
                        <small class="text-muted">{{ transaction.date|date:"m/d" }}</small>
                    </div>
                    
                    <!-- 2行目: 金額（左）と支払方法ラベル（右） -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 
                            {% if transaction.transaction_type == 'income' %}text-primary
                            {% elif transaction.transaction_type == 'expense' %}text-danger
                            {% else %}text-secondary{% endif %}">
                            {% if transaction.transaction_type == 'income' %}+{% elif transaction.transaction_type == 'expense' %}-{% endif %}¥{{ transaction.amount|comma_format }}
                        </h6>
                        <small class="text-muted" title="{{ transaction.payment_method }}">
                            <i class="fas fa-credit-card"></i> {{ transaction.payment_method|truncatechars:10 }}
                        </small>
                    </div>
                    
                    <!-- 3行目: カテゴリ・費用タイプ・取引タイプ（左）と編集・削除アイコン（右） -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="small text-muted">
                            <span title="{{ transaction.category }}"><i class="fas fa-tag"></i> {{ transaction.category|truncatechars:10 }}</span>
                            <span class="badge badge-secondary badge-sm ml-1">{{ transaction.get_major_category_display }}</span>
                            <span class="badge badge-sm ml-1
                                {% if transaction.transaction_type == 'income' %}badge-primary
                                {% elif transaction.transaction_type == 'expense' %}badge-danger
                                {% else %}badge-secondary{% endif %}">
                                {{ transaction.get_transaction_type_display }}
                            </span>
                        </div>
                        <div class="d-flex">
                            <button onclick="openEditModal({{ transaction.id }})" class="btn btn-sm btn-outline-warning mr-1 py-0 px-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="post" action="{% url 'delete_expenses' transaction.id %}" style="display: inline;" onsubmit="return confirm('この取引を削除してもよろしいですか？');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 詳細（オプション） -->
                    {% if transaction.purpose_description %}
                    <div class="small text-muted mt-1">
                        <i class="fas fa-comment"></i> {{ transaction.purpose_description|truncatechars:30 }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center py-2">
                <i class="fas fa-info-circle"></i>
                {% if search_query or filter_transaction_type or filter_major_category or filter_category or filter_payment_method %}
                    検索・絞り込み条件に一致する取引がありません。
                {% else %}
                    この月の取引はありません。
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if transactions_page.paginator.num_pages > 1 %}
    <nav aria-label="取引ページネーション">
        <ul class="pagination justify-content-center">
            {% if transactions_page.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1&target_date={{ default_target_date }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_transaction_type %}&transaction_type={{ filter_transaction_type }}{% endif %}{% if filter_major_category %}&major_category={{ filter_major_category }}{% endif %}{% if filter_category %}&category={{ filter_category }}{% endif %}{% if filter_payment_method %}&payment_method={{ filter_payment_method }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">&laquo; 最初</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions_page.previous_page_number }}&target_date={{ default_target_date }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_transaction_type %}&transaction_type={{ filter_transaction_type }}{% endif %}{% if filter_major_category %}&major_category={{ filter_major_category }}{% endif %}{% if filter_category %}&category={{ filter_category }}{% endif %}{% if filter_payment_method %}&payment_method={{ filter_payment_method }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">前へ</a>
            </li>
            {% endif %}

            {% for num in transactions_page.paginator.page_range %}
                {% if transactions_page.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > transactions_page.number|add:'-3' and num < transactions_page.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&target_date={{ default_target_date }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_transaction_type %}&transaction_type={{ filter_transaction_type }}{% endif %}{% if filter_major_category %}&major_category={{ filter_major_category }}{% endif %}{% if filter_category %}&category={{ filter_category }}{% endif %}{% if filter_payment_method %}&payment_method={{ filter_payment_method }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if transactions_page.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions_page.next_page_number }}&target_date={{ default_target_date }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_transaction_type %}&transaction_type={{ filter_transaction_type }}{% endif %}{% if filter_major_category %}&major_category={{ filter_major_category }}{% endif %}{% if filter_category %}&category={{ filter_category }}{% endif %}{% if filter_payment_method %}&payment_method={{ filter_payment_method }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">次へ</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions_page.paginator.num_pages }}&target_date={{ default_target_date }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_transaction_type %}&transaction_type={{ filter_transaction_type }}{% endif %}{% if filter_major_category %}&major_category={{ filter_major_category }}{% endif %}{% if filter_category %}&category={{ filter_category }}{% endif %}{% if filter_payment_method %}&payment_method={{ filter_payment_method }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}">最後 &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    <div class="text-center mt-2">
        <small class="text-muted">
            {{ transactions_page.start_index }} - {{ transactions_page.end_index }} / {{ transactions_page.paginator.count }}件
        </small>
    </div>
    {% endif %}
</div>

<!-- カスタムCSS -->
<link rel="stylesheet" href="{% static 'app/modal.css' %}">
<link rel="stylesheet" href="{% static 'app/transaction.css' %}">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'app/transaction.js' %}"></script>
<script>
    // データをグローバル変数として設定
    var categoryData = JSON.parse('{{ category_data_json|escapejs }}');
    var expenseData = JSON.parse('{{ expense_data_json|escapejs }}');
    var balanceData = JSON.parse('{{ balance_data_json|escapejs }}');
    var majorCategoryData = JSON.parse('{{ major_category_data_json|escapejs }}');

    // ページ読み込み後にグラフとフィルターを初期化
    document.addEventListener('DOMContentLoaded', function() {
        initializeExpenseCharts();
        initializeExpenseFilters();
    });
</script>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <!-- モーダルの内容はAjaxで読み込まれます -->
    </div>
</div>

<!-- 新規作成モーダル -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <!-- モーダルの内容はAjaxで読み込まれます -->
    </div>
</div>
{% endblock %}
